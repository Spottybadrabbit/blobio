#!/bin/bash
#
#  Synopsis:
#	Unix 'file' command run on a blob
#  Environment Variables:
#	BLOBIO_SERVICE
#	BLOBIO_GET_SERVICE
#	TMPDIR
#
PROG=$(basename $0)
TMP_FILE=${TMPDIR:=/tmp}/$PROG.$$

die()
{
	echo "$PROG: ERROR: $@" >&2
	exit 1
}

leave()
{
	STATUS=$?
	rm -f $TMP_FILE
	exit $STATUS
}

trap leave EXIT

test -n "$BLOBIO_SERVICE" || die 'env variable not defined: BLOBIO_SERVICE'
SERVICE=${BLOBIO_GET_SERVICE:=$BLOBIO_SERVICE}

while [ "$1" ]; do
	UDIG="$1";  shift

	#  blobio command will refuse to overwrite existing file

	rm -f $TMP_FILE || die "rm -f $TMP_FILE failed: exit status=$?"

	blobio get 							\
		--udig $UDIG						\
		--output-path $TMP_FILE					\
		--service $SERVICE
	STATUS=$?
	case "$STATUS" in
	0)
		;;
	1)
		echo "?$UDIG"
		continue
		;;
	*)
		die "blob get $SERVICE $UDIG failed: exit status=$STATUS"
		;;
	esac
	echo ">$UDIG	$(file --brief $TMP_FILE | sed 's/	/ /g')"
done
