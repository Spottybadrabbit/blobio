#!/bin/bash
#
#  Synopsis:
#	Get a blob into a local file named <udig>.
#  Blame:
#  	jmscott@setspace.com
#	setspace@gmail.com
#
ALGORITHM=${BLOBIO_ALGORITHM:=sha}

die()
{
	echo "$0: $@" >&2
	exit 1
}

test -n "$BLOBIO_SERVICE" || die 'env variable not defined: BLOBIO_SERVICE'

while [ "$1" ]; do
	case "$1" in
	*:*)
		UDIG=$1
		;;
	'')
		die 'empty blob'
		;;
	*)
		die "unexpected udig: $UDIG"
		;;
	esac
	shift

	FILE=$UDIG

	#
	#  Skip if file exists.  
	#
	if [ -f $FILE ];  then
		echo "@$UDIG"
		continue
	fi
	#
	#  Fetch the file from the blob server.
	#
	blobio get --udig $UDIG --service $BLOBIO_SERVICE --output-path $FILE
	STATUS=$?
	case $STATUS in
	0)
		echo ">$UDIG"
		;;
	1)
		echo "?$UDIG"
		;;
	*)
		die "blobio get $UDIG $FILE failed: status=$STATUS"
		;;
	esac
done
