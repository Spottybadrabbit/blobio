#!/bin/bash
#
#  Synopsis:
#	Brute force sync of local blobs in a chain of wrap sets to remote.
#  Description:
#	Sync local blobs derived from a chain of logs of wrapped blob request
#	requests.  The source is the local server in $BLOBIO_SERVICE.
#	The remote server is specified on the command line.  Each blob
#	is verified on the remote server with an "eat" request.
#  Usage:
#	sync-wrap-chain <remote service> <stop brr log count>
#  Exit Status:
#	0	no error, all blobs sunk across the chain of wrap sets.
#	1	wrong number of arguments
#	2	unknown error
#  Note:
#	Deleted blobs are not zapped.
#

PROG=$(basename $0)

log()
{
	echo "$(date +'%Y/%m/%d %H:%M:%S'): $@"
}

die()
{
	STATUS=$1
	case "$STATUS" in
	[0-9])
		shift
		;;
	*)
		STATUS=2
		;;
	esac

	log "ERROR: $@" >&2
	exit $STATUS
}

leave()
{
	#  zap the temporary work directory
	if [ -n "$WORK_DIR" -a -e "$WORK_DIR" ];  then
		cd ..
		rm -rf $WORK_DIR
	fi
	log 'good bye, cruel world'
	exit
}

test $# = 2 || die 1 "wrong number of arguments, got $#, expected 2"
REMOTE_SERVICE=$1
STOP_BRR_LOG_COUNT=$2
log 'hello, world'
trap leave EXIT QUIT INT TERM

log "remote service: $REMOTE_SERVICE"
log "stop brr log count: $STOP_BRR_LOG_COUNT"

#  Local profile in $BLOBIO_ROOT/etc/profile

test -n "$BLOBIO_ROOT" || die 'env variable not defined: BLOBIO_ROOT'
cd $BLOBIO_ROOT || die "cd $BLOBIO_ROOT failed: exit status=$?"
test -r etc/profile || die "profile does not exist: $(pwd)/etc/profile"
. etc/profile || die "$(pwd)/etc/profile failed"
test -n "$BLOBIO_SERVICE" || die 'environment not defined: BLOBIO_SERVICE'
log "local blobio service: $BLOBIO_SERVICE"

#  make the temporary work dir

TMPDIR=${TMPDIR:=/tmp}
WORK_DIR=$TMPDIR/$PROG-$$.d
log "work dir: $WORK_DIR"
mkdir $WORK_DIR || die "mkdir $WORK_DIR failed: exit status=$?"
cd $WORK_DIR || die "cd $WORK_DIR failed: exit status=$?"

log "walking $STOP_BRR_LOG_COUNT brr logs back ..."
walk-wrap-set --stop-brr-log-count $STOP_BRR_LOG_COUNT >WALK_WRAP_SET	||
			die "walk-wrap-set failed: exit status=$?"
test -s WALK_WRAP_SET || die 'walk wrap set is empty'

#  dump the stats of this chain of wrap set
grep '#' WALK_WRAP_SET

REMOTE_SERVICE="--service $REMOTE_SERVICE"
SERVICE="--service $BLOBIO_SERVICE"
log 'syncing local blobs to remote service'
grep '^[a-z][a-z0-9].*:' WALK_WRAP_SET | while read U;  do
	UDIG="--udig $U"
	blobio eat $REMOTE_SERVICE $UDIG
	STATUS=$?
	case $STATUS in
	0)
		log "@$U"
		continue
		;;
	1)
		;;
	*)
		die "blobio eat failed: exit status=$STATUS"
		;;
	esac

	blobio get $SERVICE $UDIG | blobio put $REMOTE_SERVICE $UDIG
	STATUS=${PIPESTATUS[*]}
	case "$STATUS" in
	'0 0')
		log ">$U"
		;;
	'1 '*)
		die "local blob does not exist: $U"
		;;
	*)
		die "blobio get | put failed: exit status=$STATUS"
		;;
	esac
done
